<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitor de Execuções de Jobs</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Tabulator CSS (local) -->
    <link href="./vendor/tabulator.min.css" rel="stylesheet" />
    <!-- Flatpickr CSS -->
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <!-- Font Awesome (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Shared styles from Gestão de Planejamento -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/gestao-planejamento.css">
    <!-- Page-specific CSS -->
    <link href="./style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar (shared) -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <button class="toggle-sidebar" title="Recolher menu">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        <nav class="sidebar-nav">
          <a href="../gestao-planejamento.html">
            <i class="fas fa-tasks"></i>
            <span>Gestão de Planejamento</span>
          </a>
          <a href="../gmud-relatorio.html">
            <i class="fas fa-list-check"></i>
            <span>Central de Mudanças</span>
          </a>
          <a href="./index.html" class="active">
            <i class="fas fa-server"></i>
            <span>Monitor de Jobs</span>
          </a>
          <a href="#" id="openChangePassword">
            <i class="fas fa-key"></i>
            <span>Alterar Senha</span>
          </a>
        </nav>
        <div class="sidebar-footer">
          <h2>Xcelis</h2>
        </div>
      </aside>

      <!-- Main content -->
      <main class="main-content">
        <!-- Top Bar (shared) -->
        <div class="top-bar">
          <div class="top-bar-content" style="display:flex; align-items:center; justify-content:space-between;">
            <h1 style="margin:0; font-size:1.5rem;">Monitor de Jobs - Xcelis</h1>
          </div>
          <div class="top-actions">
            <div class="form-check form-switch" style="color:var(--text-color); margin-right: 12px;">
              <input class="form-check-input" type="checkbox" id="toggleUTC" />
              <label class="form-check-label" for="toggleUTC">Exibir em UTC</label>
            </div>
            <button id="themeToggle" class="theme-toggle" title="Alternar tema">
              <i class="fas fa-moon"></i>
            </button>
          </div>
        </div>

        <!-- Conteúdo específico do Monitor de Jobs -->
        <section class="container-fluid my-3">
          <!-- Importação (oculta da interface) -->
          <section class="mb-4" style="display: none;">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="fileInput" class="form-label">Importar arquivo JSON</label>
                <input class="form-control" type="file" id="fileInput" accept="application/json" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Ou arraste e solte</label>
                <div id="dropZone" class="border border-2 border-secondary rounded p-3 text-center bg-white">
                  Arraste o arquivo JSON aqui
                </div>
              </div>
            </div>
            <!-- Progress bar para importação -->
            <div class="progress mt-2 d-none" id="importProgress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%">
              </div>
            </div>
          </section>

          <!-- Filtros Globais -->
          <section class="mb-4">
            <div class="card">
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label" for="dateStart">Início</label>
                    <input id="dateStart" class="form-control" placeholder="YYYY-MM-DD HH:mm" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label" for="dateEnd">Fim</label>
                    <input id="dateEnd" class="form-control" placeholder="YYYY-MM-DD HH:mm" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label" for="idJobSelect">Job</label>
                    <select id="idJobSelect" class="form-select">
                      <option value="">Todos</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label" for="textSearch">Busca de texto</label>
                    <input id="textSearch" class="form-control" placeholder="Mensagem / status" />
                  </div>
                  <div class="col-md-12">
                    <div class="d-flex flex-wrap gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="error" id="sevError" checked />
                        <label class="form-check-label" for="sevError">Erro</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="warning" id="sevWarning" checked />
                        <label class="form-check-label" for="sevWarning">Warning</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="info" id="sevInfo" />
                        <label class="form-check-label" for="sevInfo">Info</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="success" id="sevSuccess" />
                        <label class="form-check-label" for="sevSuccess">Sucesso</label>
                      </div>
                      <button id="applyFilters" class="btn btn-primary btn-sm">
                        <span id="applyFiltersText">Aplicar filtros</span>
                        <span id="applyFiltersSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                      </button>
                      <button id="loadMore" class="btn btn-outline-primary btn-sm ms-2">
                        <span id="loadMoreText">Carregar mais dados</span>
                        <span id="loadMoreSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></span>
                      </button>
                      <div id="loadMoreInfo" class="ms-3 text-muted small align-self-center d-none"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Abas -->
          <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="incidentes-tab" data-bs-toggle="tab" data-bs-target="#incidentes" type="button" role="tab">Incidentes</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab">Jobs</button>
            </li>
          </ul>
          <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom" id="tabContent">
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
              <div id="kpiRow" class="row g-3 mb-3">
                <!-- KPIs serão renderizados aqui -->
              </div>
              <div>
                <canvas id="trendChart" height="100"></canvas>
              </div>
              <!-- Indicador de carregamento geral -->
              <div id="generalLoadingIndicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <div class="mt-2 text-muted">Carregando dados...</div>
              </div>
            </div>
            <div class="tab-pane fade" id="incidentes" role="tabpanel">
              <div id="incidentsTable" class="mt-2"></div>
              <!-- Indicador de carregamento para incidentes -->
              <div id="incidentsLoadingIndicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <div class="mt-2 text-muted">Carregando incidentes...</div>
              </div>
            </div>
            <div class="tab-pane fade" id="jobs" role="tabpanel">
              <div id="jobsTable" class="mt-2"></div>
            </div>
          </div>
        </section>

      </main>
    </div>

    <!-- Dependencies via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="./vendor/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/zod@3.23.8/lib/index.umd.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Auth service required for Change Password modal -->
    <script src="../js/auth.js"></script>
    <!-- Shared JS (only for theme/navigation helpers) -->
    <script src="../js/gestao-planejamento.js"></script>
    <!-- App (modules) -->
    <script type="module" src="./app.js"></script>
    
    <!-- Modal Alterar Senha (compartilhado) -->
    <div id="changePasswordModal" class="modal-overlay hidden" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-labelledby="cp-title" aria-modal="true">
        <h3 id="cp-title" style="margin-top:0;">Alterar Senha</h3>
        <div class="form-group">
          <label for="cp-current">Senha atual</label>
          <input type="password" id="cp-current" autocomplete="current-password" />
        </div>
        <div class="form-group">
          <label for="cp-new">Nova senha</label>
          <input type="password" id="cp-new" autocomplete="new-password" />
          <small class="hint">Mín. 8 caracteres, com maiúscula, minúscula, número e especial, sem espaços.</small>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button id="cp-cancel" class="btn-secondary" type="button">Cancelar</button>
          <button id="cp-save" class="btn-primary" type="button">Salvar</button>
        </div>
      </div>
    </div>
    
    <script>
      // Estilos mínimos para o modal (garantia)
      (function ensureModalStyles(){
        const styleId = 'cp-modal-inline-style';
        if (!document.getElementById(styleId)) {
          const s = document.createElement('style');
          s.id = styleId;
          s.textContent = `
            .modal-overlay.hidden { display: none; }
            .modal-card { background: var(--card-bg, #fff); color: var(--text-color, #2c3e50); padding: 16px; border-radius: 8px; width: 100%; max-width: 380px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
            .form-group { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
            .form-group input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: var(--input-bg, #fff); color: var(--text-color, #2c3e50); }
            .hint { color: var(--text-muted, #7f8c8d); font-size: 0.8rem; }
          `;
          document.head.appendChild(s);
        }
      })();
      // Inicializa o modal de Alterar Senha e o toggle da sidebar nesta página
      document.addEventListener('DOMContentLoaded', function() {
        try { if (typeof setupChangePasswordUI === 'function') setupChangePasswordUI(); } catch(e) { console.warn(e); }
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.querySelector('.toggle-sidebar');
        if (sidebar && toggleBtn) {
          toggleBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        }
      });
    </script>
  </body>
</html>
